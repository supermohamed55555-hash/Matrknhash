<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… - Ù…ØªØ±ÙƒÙ†Ù‡Ø§Ø´</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8fafc;
        }

        .sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        }

        .stat-card {
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef9c3;
            color: #854d0e;
        }

        .status-suspended {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="sidebar w-64 text-white p-6 hidden md:block">
        <h1 class="text-2xl font-800 mb-10 text-yellow-500">Ù…ØªØ±ÙƒÙ†Ù‡Ø§Ø´ <span
                class="text-sm font-400 block text-white opacity-50">Admin Panel</span></h1>
        <nav class="space-y-4">
            <a href="#" onclick="showTab('overview')" class="block py-2 px-4 rounded hover:bg-slate-700 transition">ğŸ“Š
                Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</a>
            <a href="#" onclick="showTab('vendors')" class="block py-2 px-4 rounded hover:bg-slate-700 transition">ğŸª
                Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ø±</a>
            <a href="#" onclick="showTab('orders')" class="block py-2 px-4 rounded hover:bg-slate-700 transition">ğŸ“¦
                Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
            <a href="/" class="block py-2 px-4 rounded hover:bg-red-900 mt-20 transition">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹</a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
        <header class="flex justify-between items-center mb-10">
            <h2 id="tabTitle" class="text-3xl font-800 text-slate-800">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©</h2>
            <div class="bg-white p-2 rounded-full shadow-sm flex items-center gap-3 px-4">
                <span id="adminName" class="font-600 text-slate-600">ØªØ­Ù…ÙŠÙ„...</span>
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white">A</div>
            </div>
        </header>

        <!-- Tabs -->
        <section id="overview" class="tab-content transition-all">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
                    <h3 id="statRevenue" class="text-2xl font-800 text-slate-800">0 Ø¬.Ù…</h3>
                </div>
                <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm mb-1">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø©</p>
                    <h3 id="statOrders" class="text-2xl font-800 text-blue-600">0</h3>
                </div>
                <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm mb-1">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¬Ø§Ø±</p>
                    <h3 id="statVendors" class="text-2xl font-800 text-green-600">0</h3>
                </div>
                <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm mb-1">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© (10%)</p>
                    <h3 id="statCommission" class="text-2xl font-800 text-yellow-600">0 Ø¬.Ù…</h3>
                </div>
            </div>

            <!-- Recent Orders Preview -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h4 class="text-xl font-700 mb-4">Ø¢Ø®Ù€Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead>
                            <tr class="border-b border-slate-100 text-slate-400">
                                <th class="py-3 px-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th class="py-3 px-4">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th class="py-3 px-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Vendors Tab -->
        <section id="vendors" class="tab-content hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <table class="w-full text-right">
                    <thead>
                        <tr class="border-b border-slate-100 text-slate-400">
                            <th class="py-3 px-4">Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±</th>
                            <th class="py-3 px-4">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</th>
                            <th class="py-3 px-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="py-3 px-4">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="vendorsTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- Orders Tab -->
        <section id="orders" class="tab-content hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <table class="w-full text-right">
                    <thead>
                        <tr class="border-b border-slate-100 text-slate-400">
                            <th class="py-3 px-4">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th class="py-3 px-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th class="py-3 px-4">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="py-3 px-4">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th class="py-3 px-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="ordersFullTableBody"></tbody>
                </table>
            </div>
        </section>

    </main>

    <script>
        async function checkAdmin() {
            try {
                const res = await fetch('/auth/login/success');
                const data = await res.json();
                console.log('Admin Auth Check:', data); // Log the response

                if (!data.success || data.user.role !== 'admin') {
                    console.error('Not an admin! Data:', data);
                    alert('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¯ÙŠØ± Ø¹Ø§Ù….\nØ³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.');
                    window.location.href = '/';
                } else {
                    document.getElementById('adminName').innerText = data.user.name;
                    loadStats();
                    loadVendors();
                }
            } catch (err) {
                console.error('CheckAdmin Error:', err);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.');
            }
        }

        async function loadStats() {
            const res = await fetch('/api/admin/stats');
            const data = await res.json();
            document.getElementById('statRevenue').innerText = data.totalRevenue.toLocaleString() + ' Ø¬.Ù…';
            document.getElementById('statOrders').innerText = data.totalOrders;
            document.getElementById('statVendors').innerText = data.totalVendors;
            document.getElementById('statCommission').innerText = data.commissionBalance.toLocaleString() + ' Ø¬.Ù…';
        }

        async function loadVendors() {
            const res = await fetch('/api/admin/vendors');
            const vendors = await res.json();
            const body = document.getElementById('vendorsTableBody');
            body.innerHTML = vendors.map(v => `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                    <td class="py-4 px-4 font-600">${v.name}</td>
                    <td class="py-4 px-4 text-slate-500">${v.shopName || 'N/A'}</td>
                    <td class="py-4 px-4">
                        <span class="status-badge status-${v.status}">${v.status === 'active' ? 'Ù…ÙØ¹Ù„' : v.status === 'pending' ? 'Ø§Ù†ØªØ¸Ø§Ø±' : 'Ù…ÙˆÙ‚ÙˆÙ'}</span>
                    </td>
                    <td class="py-4 px-4 flex gap-2">
                        ${v.status === 'pending' ? `<button onclick="updateVendor('${v._id}', 'active')" class="text-sm bg-green-500 text-white px-3 py-1 rounded">ØªÙØ¹ÙŠÙ„</button>` : ''}
                        ${v.status === 'active' ? `<button onclick="updateVendor('${v._id}', 'suspended')" class="text-sm bg-red-100 text-red-600 px-3 py-1 rounded">Ø¥ÙŠÙ‚Ø§Ù</button>` : ''}
                        ${v.status === 'suspended' ? `<button onclick="updateVendor('${v._id}', 'active')" class="text-sm bg-blue-500 text-white px-3 py-1 rounded">Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        async function updateVendor(id, status) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±ØŸ')) return;
            const res = await fetch(`/api/admin/vendors/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            if (res.ok) {
                loadVendors();
                loadStats();
            }
        }

        async function loadAllOrders() {
            const res = await fetch('/api/admin/orders');
            const orders = await res.json();
            const body = document.getElementById('ordersFullTableBody');
            body.innerHTML = orders.map(o => `
                <tr class="border-b border-slate-50">
                    <td class="py-4 px-4 font-mono text-xs">#${o._id.toString().slice(-6)}</td>
                    <td class="py-4 px-4">${o.user?.name || 'Ù…Ø¬Ù‡ÙˆÙ„'}</td>
                    <td class="py-4 px-4 text-sm text-slate-400">${new Date(o.createdAt).toLocaleDateString('ar-EG')}</td>
                    <td class="py-4 px-4 font-700">${o.totalPrice} Ø¬.Ù…</td>
                    <td class="py-4 px-4 text-sm">${o.status}</td>
                </tr>
            `).join('');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            const titles = { overview: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©', vendors: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ø±', orders: 'Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª' };
            document.getElementById('tabTitle').innerText = titles[tabId];
            if (tabId === 'orders') loadAllOrders();
        }

        checkAdmin();
    </script>
</body>

</html>
