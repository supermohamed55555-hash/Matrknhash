<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ - Ù…ØªØ±ÙƒÙ†Ù‡Ø§Ø´</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a237e;
            --accent: #ffb300;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f3f4f6;
            --text: #1f2937;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg);
            margin: 0;
            padding-bottom: 80px;
            color: var(--text);
        }

        header {
            background: #1a237e;
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            text-decoration: none;
        }

        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
        }

        /* Image Section */
        .product-img-box {
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 400px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .product-img-box img {
            max-width: 100%;
            max-height: 400px;
        }

        /* Details Section */
        .product-details-box {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .sku {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        h1 {
            color: var(--primary);
            font-size: 2rem;
            margin: 0 0 10px;
            font-weight: 800;
        }

        .price {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .price-note {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        /* AI Fitment Box */
        .ai-fitment {
            background: #eef2ff;
            border: 2px solid #c7d2fe;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .ai-title {
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .fit-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
        }

        select {
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: 'Cairo';
            width: 100%;
            font-size: 0.95rem;
        }

        .check-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .check-btn:hover {
            background: #151b60;
        }

        .fit-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.95rem;
            display: none;
            line-height: 1.6;
        }

        .fit-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .fit-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Trust Box */
        .trust-box {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
        }

        .trust-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: #14532d;
            align-items: center;
        }

        .trust-item svg {
            min-width: 20px;
        }

        /* Sellers List Enhanced */
        .sellers-header {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary);
            margin: 30px 0 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .seller-card {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: 0.2s;
            background: white;
        }

        .seller-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .seller-info h4 {
            margin: 0;
            color: #333;
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trusted-badge {
            background: #e0f2f1;
            color: #00695c;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .rating {
            color: #f59e0b;
            font-size: 0.9rem;
            margin-top: 5px;
            font-weight: 600;
        }

        .meta {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
            display: flex;
            gap: 10px;
        }

        .seller-price-box {
            text-align: left;
            min-width: 100px;
        }

        .s-price {
            color: #166534;
            font-weight: 800;
            font-size: 1.3rem;
        }

        .buy-seller-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
            width: 100%;
            transition: 0.2s;
            font-family: 'Cairo';
        }

        .buy-seller-btn.outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .buy-seller-btn:hover {
            opacity: 0.9;
        }

        /* Actions */
        .actions {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .expert-btn {
            flex: 1;
            border: 2px solid var(--primary);
            background: transparent;
            color: var(--primary);
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.2s;
            font-size: 1rem;
        }

        .expert-btn:hover {
            background: #f0f4ff;
        }

        /* Smart Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 350px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            overflow: hidden;
            display: none;
            border: 1px solid #eee;
            flex-direction: column;
        }

        .chat-header {
            background: #128c7e;
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-body {
            height: 300px;
            padding: 15px;
            background: #efeae2;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            font-size: 0.9rem;
            position: relative;
        }

        .msg-bot {
            background: white;
            align-self: flex-start;
            border-top-left-radius: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .chat-footer {
            padding: 10px;
            background: #f0f0f0;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            outline: none;
            font-family: 'Cairo';
        }

        .send-btn {
            background: #128c7e;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media(max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .fit-form {
                grid-template-columns: 1fr;
            }

            .seller-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .seller-price-box {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .buy-seller-btn {
                width: auto;
                margin: 0;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="nav-container">
            <a href="index.html" class="logo">Ù…ØªØ±ÙƒÙ†Ù‡Ø§Ø´</a>
            <a href="profile.html" style="color:white; text-decoration:none; font-weight:bold;">ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ</a>
        </div>
    </header>

    <div class="main-container">
        <!-- Image -->
        <div class="product-img-box">
            <img id="pImg" src="https://via.placeholder.com/500" alt="Product">
            <span
                style="position: absolute; top:20px; right:20px; background:#4caf50; color:white; padding:5px 15px; border-radius:20px; font-size:0.8rem; font-weight:bold;">Ø£ØµÙ„ÙŠ
                100%</span>
        </div>

        <!-- Details -->
        <div class="product-details-box">
            <div class="sku">SKU: MRK-9921</div>
            <h1 id="pName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
            <div class="price" id="pPrice">-- Ø¬.Ù…</div>
            <div class="price-note">ÙŠØ¨Ø¯Ø£ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± (Ù‚Ø§Ø±Ù† Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ¬Ø§Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„)</div>

            <!-- Smart Fitment AI -->
            <div class="ai-fitment">
                <div class="ai-title">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" />
                    </svg>
                    AI Fitment Check (ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù‚Ø·Ø¹Ø© ØªÙ†Ø§Ø³Ø¨ Ø³ÙŠØ§Ø±ØªÙƒ)
                </div>
                <div class="fit-form" style="display: block;">
                    <div style="position: relative; margin-bottom: 10px;">
                        <input type="text" id="userVehicleText" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¨ØªØ±ÙƒØ¨ Ø¹Ù„Ù‰ ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§ Ù¢Ù Ù¡Ù¥ØŸ"
                            style="width: 100%; padding: 15px 45px 15px 15px; border-radius: 30px; border: 1.5px solid #c7d2fe; box-sizing: border-box; font-family: 'Cairo';">
                        <svg style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6366f1;"
                            width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                        </svg>
                    </div>
                    <button class="check-btn" onclick="checkFitAI()"
                        style="width: 100%; padding:15px; border-radius:30px;">Ø§ÙØ­Øµ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
                </div>
                <div id="fitResult" class="fit-result"></div>
            </div>

            <!-- Trust Indicators -->
            <div class="trust-box">
                <div class="trust-item">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
                    </svg>
                    <strong>Ù†Ø¸Ø§Ù… Escrow:</strong> ÙÙ„ÙˆØ³Ùƒ Ù…Ø´ Ù‡ØªÙˆØµÙ„ Ù„Ù„ØªØ§Ø¬Ø± ØºÙŠØ± Ù„Ù…Ø§ ØªØ³ØªÙ„Ù… ÙˆØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø·Ø¹Ø©.
                </div>
                <div class="trust-item">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M1.5 1.5A.5.5 0 0 0 1 2v4.8a2.5 2.5 0 0 0 2.5 2.5h9.793l-3.347 3.346a.5.5 0 0 0 .708.708l4.2-4.2a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 8.3H3.5A1.5 1.5 0 0 1 2 6.8V2a.5.5 0 0 0-.5-.5z" />
                    </svg>
                    <strong>Ø¶Ù…Ø§Ù† 14 ÙŠÙˆÙ…:</strong> Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¬Ø§Ù†ÙŠ 100% Ù„Ùˆ Ø§Ù„Ù‚Ø·Ø¹Ø© ÙÙŠÙ‡Ø§ Ø¹ÙŠØ¨.
                </div>
            </div>

            <!-- Sellers List Enhanced -->
            <h3 class="sellers-header">Ù‚Ø§Ø±Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† 3 ØªØ¬Ø§Ø±</h3>

            <!-- Seller 1 -->
            <div class="seller-card">
                <div class="seller-info">
                    <h4>Ù…Ø­Ù„Ø§Øª Ø§Ù„ØªÙˆÙÙŠÙ‚ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª <span class="trusted-badge">Ù…ÙˆØ«ÙˆÙ‚ âœ…</span></h4>
                    <div class="rating">â­â­â­â­â­ 4.9 (500+ Ø·Ù„Ø¨)</div>
                    <div class="meta">ğŸ“ Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© â€¢ ğŸšš Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ</div>
                </div>
                <div class="seller-price-box">
                    <div class="s-price">450 Ø¬.Ù…</div>
                    <button class="buy-seller-btn" onclick="addToCart('Ù…Ø­Ù„Ø§Øª Ø§Ù„ØªÙˆÙÙŠÙ‚')">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
                </div>
            </div>

            <!-- Seller 2 -->
            <div class="seller-card">
                <div class="seller-info">
                    <h4>Ø£ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨ Ù„Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</h4>
                    <div class="rating">â­â­â­â­ 4.2</div>
                    <div class="meta">ğŸ“ Ø§Ù„Ø­Ø±ÙÙŠÙŠÙ† â€¢ ğŸšš Ø´Ø­Ù† 50 Ø¬.Ù…</div>
                </div>
                <div class="seller-price-box">
                    <div class="s-price">440 Ø¬.Ù…</div>
                    <button class="buy-seller-btn outline" onclick="addToCart('Ø£ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨')">Ø´Ø±Ø§Ø¡</button>
                </div>
            </div>

            <!-- Seller 3 -->
            <div class="seller-card">
                <div class="seller-info">
                    <h4>El-Masry Auto Parts</h4>
                    <div class="rating">â­â­â­â­â­ 4.7</div>
                    <div class="meta">ğŸ“ Ø§Ù„Ø¯Ù‚ÙŠØŒ Ø§Ù„Ø¬ÙŠØ²Ø© â€¢ âš¡ Ø´Ø­Ù† Ø³Ø±ÙŠØ¹</div>
                </div>
                <div class="seller-price-box">
                    <div class="s-price">465 Ø¬.Ù…</div>
                    <button class="buy-seller-btn outline" onclick="addToCart('Ø§Ù„Ù…ØµØ±ÙŠ Ø£ÙˆØªÙˆ')">Ø´Ø±Ø§Ø¡</button>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="expert-btn" onclick="openChat()">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M16 8c0 3.866-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.584.234-1.953.109-2.888-.813C4.911 2.71 12.685 0 16 8zm-8 4.743A7.051 7.051 0 0 1 2.485 10.4c.664-.95 1.776-3.953 5.432-5.719C10.741 3.522 13 5.093 13 8c0 2.227-1.789 4.223-4.916 4.743z" />
                    </svg>
                    Ø§Ø³Ø£Ù„ Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø®ØªØµ (ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±)
                </button>
            </div>
        </div>
    </div>

    <!-- Live Widget -->
    <div class="chat-widget" id="chatWidget">
        <div class="chat-header">
            <span>Ù…Ù‡Ù†Ø¯Ø³ Ù…ØªØ±ÙƒÙ†Ù‡Ø§Ø´ ğŸ‘·â€â™‚ï¸</span>
            <span onclick="document.getElementById('chatWidget').style.display='none'" style="cursor:pointer;">âœ–</span>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="msg msg-bot">
                Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ!
                Ø£Ù†Ø§ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„. Ø¹Ø´Ø§Ù† Ø£Ø³Ø§Ø¹Ø¯Ùƒ ØµØ­ØŒ ÙŠØ§Ø±ÙŠØª ØªØ¨Ø¹ØªÙ„ÙŠ ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡ Ù‡Ù†Ø§ ÙˆÙ‡Ø±Ø¯ Ø¹Ù„ÙŠÙƒ ÙÙˆØ±Ø§Ù‹.
            </div>
        </div>
        <div class="chat-footer">
            <input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."
                onkeypress="if(event.key==='Enter') sendToWhatsApp()">
            <button class="send-btn" onclick="sendToWhatsApp()">â¤</button>
        </div>
    </div>

    <script>
        // 1. Data Setup from URL
        const urlParams = new URLSearchParams(window.location.search);
        const partName = urlParams.get('part') || "Ù…Ù†ØªØ¬ Ø¹Ø§Ù…";
        const imgUrl = urlParams.get('img') || "https://via.placeholder.com/500?text=AutoPart";
        const partPrice = urlParams.get('price') || "450";
        const partVendor = urlParams.get('vendor') || "Ù…ØªØ±ÙƒÙ†Ù‡Ø§Ø´";
        const partCondition = urlParams.get('condition') || "Ø¬Ø¯ÙŠØ¯";
        const partWarranty = urlParams.get('warranty') || "Ù„Ø§ ÙŠÙˆØ¬Ø¯";

        document.getElementById('pName').innerText = partName;
        document.getElementById('pImg').src = imgUrl;
        document.getElementById('pPrice').innerText = `${partPrice} Ø¬.Ù…`;

        // 2. Fetch Other Sellers (Dynamic Comparison)
        async function fetchOtherSellers() {
            try {
                const res = await fetch('/api/products');
                const products = await res.json();

                // Find products with similar names to show as other sellers
                // exclude the current one if possible, but for simplicity we show all matches
                const others = products.filter(p => p.name.includes(partName.split(' ')[0])); // Match first word

                const sellersContainer = document.querySelector('.sellers-header').nextElementSibling;
                // Clear the static entries (we'll replace them all)
                let html = '';

                others.forEach(p => {
                    html += `
                        <div class="seller-card">
                            <div class="seller-info">
                                <h4>${p.vendorName} <span class="trusted-badge">Ù…ÙˆØ«ÙˆÙ‚ âœ…</span></h4>
                                <div class="rating">â­â­â­â­â­ 4.9 (Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹)</div>
                                <div class="meta">ğŸ“ Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø·Ø¹Ø©: ${p.condition} â€¢ ğŸ›¡ï¸ Ø¶Ù…Ø§Ù†: ${p.warranty}</div>
                            </div>
                            <div class="seller-price-box">
                                <div class="s-price">${p.price} Ø¬.Ù…</div>
                                <button class="buy-seller-btn" onclick="addToCart('${p.vendorName}')">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
                            </div>
                        </div>
                    `;
                });

                if (others.length > 0) {
                    // Replace the static content starting from the first seller card
                    const sellersHeader = document.querySelector('.sellers-header');
                    let next = sellersHeader.nextElementSibling;
                    while (next && next.classList.contains('seller-card')) {
                        let toDelete = next;
                        next = next.nextElementSibling;
                        toDelete.remove();
                    }
                    sellersHeader.insertAdjacentHTML('afterend', html);
                }
            } catch (err) {
                console.error('Failed to load other sellers:', err);
            }
        }

        fetchOtherSellers();

        // 3. AI Fitment Logic (Hybrid API Call)
        async function checkFitAI() {
            const userText = document.getElementById('userVehicleText').value;
            const resultBox = document.getElementById('fitResult');
            const productId = urlParams.get('id'); // Ensure we have the product ID

            if (!userText) { alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø±Ø¨ÙŠØªÙƒ Ø§Ù„Ø£ÙˆÙ„!"); return; }

            resultBox.style.display = 'block';
            resultBox.innerHTML = '<div style="display:flex; align-items:center; gap:10px;"> <div class="spinner" style="width:15px; height:15px; border:2px solid #ccc; border-top-color:#6366f1; border-radius:50%; animation:spin 0.8s linear infinite;"></div> Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...</div>';
            resultBox.className = "fit-result";

            try {
                // The correct ID parameter is 'id' from the URL
                const pid = urlParams.get('id');

                const res = await fetch('/api/check-fitment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId: pid, userText: userText })
                });

                const data = await res.json();

                if (data.status === 'success') {
                    resultBox.className = "fit-result fit-success";
                } else if (data.status === 'warning') {
                    resultBox.className = "fit-result"; // Neutrual
                    resultBox.style.background = "#fffbeb";
                    resultBox.style.color = "#92400e";
                    resultBox.style.border = "1px solid #fde68a";
                } else {
                    resultBox.className = "fit-result fit-error";
                }

                resultBox.innerHTML = `<strong>${data.reason || data.error || 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§'}</strong>`;

            } catch (err) {
                console.error('Fitment API Error:', err);
                resultBox.className = "fit-result fit-error";
                resultBox.innerHTML = "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ ÙƒÙ…Ø§Ù† Ø´ÙˆÙŠØ©.";
            }
        }

        // Add CSS for spinner
        const style = document.createElement('style');
        style.innerHTML = '@keyframes spin { to { transform: rotate(360deg); } }';
        document.head.appendChild(style);

        // 4. WhatsApp Bridge
        function openChat() { document.getElementById('chatWidget').style.display = 'flex'; }

        function sendToWhatsApp() {
            const msg = document.getElementById('chatInput').value;
            if (!msg) return;
            const phone = "201102233317";
            const text = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ø¨Ø³ØªÙØ³Ø± Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬: (${partName}).\n Ø³Ø¤Ø§Ù„ÙŠ: ${msg}`;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank');
        }

        function addToCart(seller) {
            alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø±: ${seller}`);
        }
    </script>
</body>

</html>
